define ("qtype_graphchecker/ui_graph",["jquery","qtype_graphchecker/graphutil","qtype_graphchecker/graphelements"],function(a,b,c){function d(b,c,d,e){this.parent=b;this.canvas=a(document.createElement("canvas"));this.canvas.attr({id:c,class:"graphchecker_graphcanvas",tabindex:1});this.canvas.css({"background-color":"white"});this.canvas.on("mousedown",function(a){return b.mousedown(a)});this.canvas.on("mouseup",function(a){return b.mouseup(a)});this.canvas.on("keydown",function(a){return b.keydown(a)});this.canvas.on("mousemove",function(a){return b.mousemove(a)});this.canvas.on("keypress",function(a){return b.keypress(a)});this.resize=function(a,b){this.canvas.attr("width",a);this.canvas.attr("height",b)};this.resize(d,e)}function e(b,d,e,f,g,h,i){var j=this;this.parent=b;this.buttonSize=g;this.uiMode=h;this.helpOverlay=i;this.div=a(document.createElement("div"));this.div.attr({id:d,class:"graphchecker_toolbar",tabindex:0});this.buttons=[];this.checkboxes=[];this.selectionOptions=[];a(document).ready(function(){j.toolbarLeftPart=j.createToolbarPartObject(j.div[0].id,j.div[0].style.height,"left");j.toolbarMiddlePart=j.createToolbarPartObject(j.div[0].id,j.div[0].style.height,"middle");j.toolbarRightPart=j.createToolbarPartObject(j.div[0].id,j.div[0].style.height,"right");var a=new c.ModeButton(j,j.toolbarLeftPart,j.buttonSize.w,j.buttonSize.h,"fa-pencil","Draw mode",c.ModeType.DRAW);a.create();j.buttons.push(a);var b=new c.ModeButton(j,j.toolbarLeftPart,j.buttonSize.w,j.buttonSize.h,"fa-mouse-pointer","Edit mode",c.ModeType.EDIT);b.create();j.buttons.push(b);var d=new c.HelpButton(j,j.toolbarRightPart,j.buttonSize.w,j.buttonSize.h,"fa-question","Help menu");d.create();j.buttons.push(d);for(var g=0;g<j.buttons.length;g++){if(j.buttons[g]instanceof c.ModeButton&&j.buttons[g].buttonModeType===j.uiMode){j.buttons[g].setSelected()}}j.setButtonsEventListener(j.buttons);j.resize(e,f)});this.onModeButtonPressed=function(a){this.parent.setUIMode(a.buttonModeType);for(var b=0;b<this.buttons.length;b++){if(this.buttons[b]instanceof c.ModeButton&&this.buttons[b]!==a){this.buttons[b].setDeselected()}}if(a.buttonModeType===c.ModeType.DRAW){this.removeSelectionOptions();this.removeFSMNodeSelectionOptions()}};this.resize=function(b,c){this.div.css({width:b});this.div.css({height:c});if(this.toolbarMiddlePart!==void 0){var d=a(this.toolbarLeftPart[0]).outerWidth(),e=a(this.toolbarRightPart[0]).outerWidth(),f=a(this.toolbarMiddlePart[0]).innerWidth()-a(this.toolbarMiddlePart[0]).width(),g=a(this.parent.graphCanvas.canvas).width();a(this.toolbarMiddlePart).width(g-d-e-f)}};this.resize(e,f)}e.prototype.displayHelpOverlay=function(){this.helpOverlay.div[0].style.display="block";this.helpOverlay.div.addClass("visible");a("body").addClass("unscrollable")};e.prototype.createToolbarPartObject=function(b,c,d){console.log("blabla");console.log(b,c,d);var e=a("<div/>").attr({id:"toolbar_part_"+d,class:"toolbar_part",style:"height: "+parseFloat(c)+"px;"});console.log(e);a("#"+b).append(e);return e};e.prototype.setButtonsEventListener=function(b){a(".toolbar_button").click(function(c){c.preventDefault();for(var d=0;d<b.length;d++){if(c.target===a(b[d].button)[0]){b[d].onClick(c)}}})};e.prototype.addSelectionOptions=function(){if(0<this.selectionOptions.length){for(var b=0;b<this.selectionOptions.length;b++){}return}var a=new c.TextField(this,this.toolbarMiddlePart,8,"Label",this.onInteractTextField);a.create();this.selectionOptions.push(a)};e.prototype.removeSelectionOptions=function(){for(var b=0;b<this.selectionOptions.length;b++){a(this.selectionOptions[b].object).remove();this.selectionOptions.splice(b--,1)}};e.prototype.onInteractTextField=function(){};e.prototype.addFSMNodeSelectionOptions=function(b){if(0<this.checkboxes.length){for(var f=0;f<this.checkboxes.length;f++){if(this.checkboxes[f].type===c.CheckboxType.FSM_INITIAL){a(a(this.checkboxes[f]).attr("object").get(0)).find("input").get(0).checked=b.hasStartLink(this.parent.links)}if(this.checkboxes[f].type===c.CheckboxType.FSM_FINAL){a(a(this.checkboxes[f]).attr("object").get(0)).find("input").get(0).checked=b.isFinal}}return}var d=new c.Checkbox(this,this.toolbarMiddlePart,c.CheckboxType.FSM_INITIAL,"Initial",this.onClickFSMInitialCheckbox);d.create();a(a(d).attr("object").get(0)).find("input").get(0).checked=b.hasStartLink(this.parent.links);this.checkboxes.push(d);var e=new c.Checkbox(this,this.toolbarMiddlePart,c.CheckboxType.FSM_FINAL,"Final",this.onClickFSMFinalCheckbox);e.create();a(a(e).attr("object").get(0)).find("input").get(0).checked=b.isFinal;this.checkboxes.push(e)};e.prototype.removeFSMNodeSelectionOptions=function(){for(var b=0;b<this.checkboxes.length;b++){if(this.checkboxes[b].type===c.CheckboxType.FSM_INITIAL||this.checkboxes[b].type===c.CheckboxType.FSM_FINAL){a(this.checkboxes[b].object).remove();this.checkboxes.splice(b--,1)}}};e.prototype.onClickFSMInitialCheckbox=function(a){if(a.target.checked){this.toolbar.parent.setInitialFSMVertex(this.toolbar.parent.selectedObject);this.toolbar.parent.draw()}else{this.toolbar.parent.removeInitialFSMVertex(this.toolbar.parent.selectedObject);this.toolbar.parent.draw()}};e.prototype.onClickFSMFinalCheckbox=function(){if(this.toolbar.parent.selectedObject instanceof c.Node&&this.toolbar.parent.isFsm()){this.toolbar.parent.selectedObject.isFinal=!this.toolbar.parent.selectedObject.isFinal;this.toolbar.parent.draw()}};function f(b,c){var d=this;this.parent=b;this.div=a(document.createElement("div"));this.div.attr({id:c+"_background",class:"graphchecker_overlay",tabindex:0});a(this.div).on("click",function(){d.div.removeClass("visible");setTimeout(function(){d.div.css("display","none");a("body").removeClass("unscrollable")}.bind(this),500)});this.divDialog=a(document.createElement("div"));this.divDialog.attr({id:c+"dialog",class:"dialog",tabindex:0});a(this.divDialog).on("click",function(){return!1});this.div.append(this.divDialog)}f.prototype.insertHelpText=function(a){this.divDialog.append(a)};function g(b,c,g,h){var i=this;this.SNAP_TO_PADDING=6;this.DUPLICATE_LINK_OFFSET=16;this.HIT_TARGET_PADDING=6;this.DEFAULT_NODE_RADIUS=26;this.DEFAULT_FONT_SIZE=20;this.TOOLBAR_HEIGHT=35;this.BUTTON_SIZE={w:35,h:25};this.INITIAL_FSM_NODE_LINK_LENGTH=25;this.canvasId="graphcanvas_"+b;this.textArea=a(document.getElementById(b));this.uiMode=this.getUIModeBeginning();this.readOnly=this.textArea.prop("readonly");this.templateParams=h;this.graphCanvas=new d(this,this.canvasId,c,g);this.helpOverlayId="graphcanvas_overlay_"+b;this.helpOverlay=new f(this,this.helpOverlayId,3/4,c,g+this.TOOLBAR_HEIGHT,0,"0.2","white");this.toolbarId="toolbar_"+b;this.toolbar=new e(this,this.toolbarId,c,this.TOOLBAR_HEIGHT,this.BUTTON_SIZE,this.uiMode,this.helpOverlay);this.containerDiv=a(document.createElement("div"));a(this.containerDiv).addClass("graph_ui_container_div");this.caretVisible=!0;this.caretTimer=0;this.originalClick=null;this.nodes=[];this.links=[];this.selectedObject=null;this.clickedObject=null;this.currentLink=null;this.movingObject=!1;this.fail=!1;this.failString=null;if("helpmenutext"in h){this.helpOverlay.insertHelpText(h.helpmenutext)}else{require(["core/str"],function(b){var c=b.get_string("graphhelp","qtype_graphchecker");a.when(c).done(function(a){i.helpOverlay.insertHelpText(a)})})}this.reload();if(!this.fail){this.draw()}}g.prototype.failed=function(){return this.fail};g.prototype.failMessage=function(){return this.failString};g.prototype.getElement=function(){this.containerDiv.append(this.getHelpOverlay());this.containerDiv.append(this.getToolbar());this.containerDiv.append(this.getCanvas());return this.containerDiv};g.prototype.hasFocus=function(){return document.activeElement==this.getCanvas()};g.prototype.getCanvas=function(){return this.graphCanvas.canvas[0]};g.prototype.getToolbar=function(){return this.toolbar.div[0]};g.prototype.getHelpOverlay=function(){return this.helpOverlay.div};g.prototype.getUIModeBeginning=function(){var b=a(this.textArea).val();if(b){var d=JSON.parse(b);if(0===d.vertices.length){return c.ModeType.DRAW}else{return c.ModeType.EDIT}}else{return c.ModeType.DRAW}};g.prototype.setUIMode=function(a){this.uiMode=a;this.clickedObject=null;this.selectedObject=null};g.prototype.nodeRadius=function(){return this.templateParams.noderadius?this.templateParams.noderadius:this.DEFAULT_NODE_RADIUS};g.prototype.fontSize=function(){return this.templateParams.fontsize?this.templateParams.fontsize:this.DEFAULT_FONT_SIZE};g.prototype.isFsm=function(){return this.templateParams.isfsm!==void 0?this.templateParams.isfsm:!0};g.prototype.isPetri=function(){return this.templateParams.ispetri!==void 0?this.templateParams.ispetri:!0};g.prototype.arrowIfReqd=function(a,c,d,e){if(this.templateParams.isdirected===void 0||this.templateParams.isdirected){b.drawArrow(a,c,d,e)}};g.prototype.sync=function(){};g.prototype.keypress=function(a){var c=b.crossBrowserKey(a);if(this.readOnly){return}if(32<=c&&126>=c&&!a.metaKey&&!a.altKey&&!a.ctrlKey&&null!==this.selectedObject&&"text"in this.selectedObject){this.selectedObject.text+=String.fromCharCode(c);this.resetCaret();this.draw();return!1}else if(8===c||32===c||9===c){return!1}};g.prototype.mousedown=function(a){var d=b.crossBrowserRelativeMousePos(a);if(this.readOnly){return}this.clickedObject=this.getMouseOverObject(d.x,d.y);this.movingObject=!1;this.movingGraph=!1;this.originalClick=d;if(0===a.button){if(this.uiMode===c.ModeType.DRAW){if(null===this.clickedObject&&null===this.currentLink){var e=new c.Node(this,d.x,d.y);if(this.isPetri()){e.petriNodeType=c.PetriNodeType.PLACE}this.nodes.push(e);this.resetCaret();this.draw();if(1===this.nodes.length&&this.isFsm()){this.setInitialFSMVertex(e)}}}else if(this.uiMode===c.ModeType.EDIT){this.selectedObject=this.clickedObject;if(this.clickedObject instanceof c.Node||this.clickedObject instanceof c.Link||this.clickedObject instanceof c.StartLink||this.clickedObject instanceof c.SelfLink){this.toolbar.addSelectionOptions(this.clickedObject)}else{this.toolbar.removeSelectionOptions()}if(this.isFsm()){if(this.clickedObject instanceof c.Node){this.toolbar.addFSMNodeSelectionOptions(this.clickedObject)}else{this.toolbar.removeFSMNodeSelectionOptions()}}if(!(this.templateParams.locknodes&&this.clickedObject instanceof c.Node)&&!(this.templateParams.lockedges&&this.clickedObject instanceof c.Link)){this.movingObject=!0;if(null!==this.clickedObject&&this.clickedObject.setMouseStart){this.clickedObject.setMouseStart(d.x,d.y)}}this.resetCaret()}}this.draw();if(this.hasFocus()){return!1}else{this.resetCaret();return!0}};g.prototype.keydown=function(a){var c=b.crossBrowserKey(a),d;if(this.readOnly){return}if(8===c){if(null!==this.selectedObject&&"text"in this.selectedObject){this.selectedObject.text=this.selectedObject.text.substr(0,this.selectedObject.text.length-1);this.resetCaret();this.draw()}return!1}else if(46===c){if(null!==this.selectedObject){for(d=0;d<this.nodes.length;d++){if(this.nodes[d]===this.selectedObject){this.nodes.splice(d--,1)}}for(d=0;d<this.links.length;d++){if(this.links[d]===this.selectedObject||this.links[d].node===this.selectedObject||this.links[d].nodeA===this.selectedObject||this.links[d].nodeB===this.selectedObject){this.links.splice(d--,1)}}this.selectedObject=null;this.draw()}}else if(13===c){if(null!==this.selectedObject){this.selectedObject=null;this.draw()}}};g.prototype.resize=function(a,b){a=a+1;this.graphCanvas.resize(a,b+14);this.toolbar.resize(a,this.TOOLBAR_HEIGHT);this.draw()};g.prototype.mousemove=function(a){var d=b.crossBrowserRelativeMousePos(a),e;if(this.readOnly){return}if(this.uiMode===c.ModeType.DRAW){if(this.clickedObject instanceof c.Node){var h=this.getMouseOverObject(d.x,d.y);if(!(h instanceof c.Node)){h=null}if(h===this.clickedObject){this.currentLink=new c.SelfLink(this,this.clickedObject,d)}else if(null!==h){this.currentLink=new c.Link(this,this.clickedObject,h)}else{e=this.clickedObject.closestPointOnCircle(d.x,d.y);this.currentLink=new c.TemporaryLink(this,e,d)}}}else if(this.uiMode===c.ModeType.EDIT){if(null!==this.clickedObject){if(this.movingGraph){for(var f=this.movingNodes,g=0;g<f.length;g++){f[g].trackMouse(d.x,d.y);this.snapNode(f[g])}}else if(this.movingObject){this.clickedObject.setAnchorPoint(d.x,d.y);if(this.clickedObject instanceof c.Node){this.snapNode(this.clickedObject)}}}}this.draw()};g.prototype.mouseup=function(){if(this.readOnly){return}this.clickedObject=null;if(null!==this.currentLink){if(!(this.currentLink instanceof c.TemporaryLink)){this.addLink(this.currentLink);this.resetCaret()}this.currentLink=null;this.draw()}};g.prototype.getMouseOverObject=function(a,b){var c;for(c=0;c<this.nodes.length;c++){if(this.nodes[c].containsPoint(a,b)){return this.nodes[c]}}for(c=0;c<this.links.length;c++){if(this.links[c].containsPoint(a,b)){return this.links[c]}}return null};g.prototype.setInitialFSMVertex=function(a){if(this.isFsm()&&a instanceof c.Node){a.isInitial=!0;var d=b.getAnglesOfIncidentLinks(this.links,a),e=3/4*Math.PI,f=this.nodeRadius()+2*this.INITIAL_FSM_NODE_LINK_LENGTH,g={};if(0===d.length){g.x=a.x-(this.nodeRadius()+this.INITIAL_FSM_NODE_LINK_LENGTH);g.y=a.y-(this.nodeRadius()+this.INITIAL_FSM_NODE_LINK_LENGTH)}else if(1===d.length){var j=(d[0]+Math.PI)%(2*Math.PI);d=b.getAnglesStartLinkFSMOneIncident(j,2*Math.PI,e,8);d=d.sort(function(c,a){return Math.abs(e-c)-Math.abs(e-a)});g.x=a.x+f*Math.cos(d[0]);g.y=a.y-f*Math.sin(d[0])}else{d=d.sort(function(c,a){return c-a});var h=b.getAnglesStartLinkFSMMultipleIncident(d,e,8),i=h;h=b.filterOutCloseAngles(h,d,.05);if(0<h.length){h.sort(function(c,a){return Math.abs(e-c)-Math.abs(e-a)});g.x=a.x+f*Math.cos(h[0]);g.y=a.y-f*Math.sin(h[0])}else{var k=b.getAngleMaximumMinimumProximity(i,d);g.x=a.x+f*Math.cos(k);g.y=a.y-f*Math.sin(k)}}this.currentLink=new c.StartLink(this,a,g);this.addLink(this.currentLink);this.currentLink=null;this.toolbar.parent.draw()}};g.prototype.removeInitialFSMVertex=function(a){for(var b=0;b<this.links.length;b++){if(this.links[b]instanceof c.StartLink&&this.links[b].node===a){this.links.splice(b--,1)}}};g.prototype.snapNode=function(a){for(var b=0;b<this.nodes.length;b++){if(this.nodes[b]===a){continue}if(Math.abs(a.x-this.nodes[b].x)<this.SNAP_TO_PADDING){a.x=this.nodes[b].x}if(Math.abs(a.y-this.nodes[b].y)<this.SNAP_TO_PADDING){a.y=this.nodes[b].y}}};g.prototype.addLink=function(a){for(var b=null,c=0,d;c<this.links.length;c++){d=this.links[c];if(d.nodeA===a.nodeA&&d.nodeB===a.nodeB){if(null===b||d.perpendicularPart>b){b=d.perpendicularPart}}if(d.nodeA===a.nodeB&&d.nodeB===a.nodeA){if(null===b||-d.perpendicularPart>b){b=-d.perpendicularPart}}}if(null!==b){a.perpendicularPart=b+this.DUPLICATE_LINK_OFFSET}this.links.push(a)};g.prototype.reload=function(){var b=a(this.textArea).val();if(b){try{var d=JSON.parse(b),e;if(!d.hasOwnProperty("_version")||1!==d._version){throw"invalid version"}for(e=0;e<d.vertices.length;e++){var f=d.vertices[e],g=new c.Node(this,f.position[0],f.position[1]);g.text=f.label;if(this.isFsm()){g.isInitial=f.initial;g.isFinal=f.final}if(this.isPetri()){g.petriNodeType=f.petri_type}this.nodes.push(g)}for(e=0;e<d.edges.length;e++){var h=d.edges[e],j=null;if(h.from===h.to){j=new c.SelfLink(this,this.nodes[h.from]);j.text=h.label;j.anchorAngle=h.bend.anchorAngle}else if(-1===h.from){j=new c.StartLink(this,this.nodes[h.to]);j.deltaX=h.bend.deltaX;j.deltaY=h.bend.deltaY}else{j=new c.Link(this,this.nodes[h.from],this.nodes[h.to]);j.text=h.label;j.parallelPart=h.bend.parallelPart;j.perpendicularPart=h.bend.perpendicularPart;j.lineAngleAdjust=h.bend.lineAngleAdjust}this.links.push(j)}}catch(a){this.fail=!0;this.failString="graph_ui_invalidserialisation"}}};g.prototype.save=function(){var a={_version:1,vertices:[],edges:[]},b;if(!JSON||""===this.textArea.val().trim()&&0===this.nodes.length){return}for(b=0;b<this.nodes.length;b++){var d=this.nodes[b],e={label:d.text,position:[d.x,d.y]};if(this.isFsm()){e.initial=d.isInitial;e.final=d.isFinal}if(this.isPetri()){e.petri_type=d.petriNodeType}a.vertices.push(e)}for(b=0;b<this.links.length;b++){var f=this.links[b];if(f instanceof c.SelfLink){a.edges.push({from:this.nodes.indexOf(f.node),to:this.nodes.indexOf(f.node),label:f.text,bend:{anchorAngle:f.anchorAngle}})}else if(f instanceof c.StartLink){a.edges.push({from:-1,to:this.nodes.indexOf(f.node),bend:{deltaX:f.deltaX,deltaY:f.deltaY}})}else if(f instanceof c.Link){a.edges.push({from:this.nodes.indexOf(f.nodeA),to:this.nodes.indexOf(f.nodeB),label:f.text,bend:{lineAngleAdjust:f.lineAngleAdjust,parallelPart:f.parallelPart,perpendicularPart:f.perpendicularPart}})}}this.textArea.val(JSON.stringify(a))};g.prototype.destroy=function(){clearInterval(this.caretTimer);this.graphCanvas.canvas.off();this.graphCanvas.canvas.remove();this.toolbar.div.off();this.toolbar.div.remove();this.helpOverlay.div.off();this.helpOverlay.div.remove()};g.prototype.resetCaret=function(){var a=this;clearInterval(this.caretTimer);this.caretTimer=setInterval(function(){a.caretVisible=!a.caretVisible;a.draw()},500);this.caretVisible=!0};g.prototype.draw=function(){var a=this.getCanvas(),b=a.getContext("2d"),c;b.clearRect(0,0,this.getCanvas().width,this.getCanvas().height);b.save();for(c=0;c<this.nodes.length;c++){b.lineWidth=1;b.fillStyle=b.strokeStyle=this.nodes[c]===this.selectedObject?"blue":"black";this.nodes[c].draw(b)}for(c=0;c<this.links.length;c++){b.lineWidth=1;b.fillStyle=b.strokeStyle=this.links[c]===this.selectedObject?"blue":"black";this.links[c].draw(b)}if(null!==this.currentLink){b.lineWidth=1;b.fillStyle=b.strokeStyle="black";this.currentLink.draw(b)}b.restore();this.save()};g.prototype.drawText=function(a,d,e,f,g){var h=this.getCanvas().getContext("2d"),c=b.convertLatexShortcuts(a),i,j;h.font=this.fontSize()+"px Arial";i=h.measureText(c).width;d-=i/2;if(null!==f){var k=Math.cos(f),l=Math.sin(f),m=i/2*(0<k?1:-1),n=10*(0<l?1:-1),o=l*Math.pow(Math.abs(l),40)*m-k*Math.pow(Math.abs(k),10)*n;d+=m-l*o;e+=n+k*o}if("advancedFillText"in h){h.advancedFillText(c,a,d+i/2,e,f)}else{d=Math.round(d);e=Math.round(e);j=Math.round(this.fontSize()/3);h.fillText(c,d,e+j);if(g==this.selectedObject&&this.caretVisible&&this.hasFocus()&&document.hasFocus()){d+=i;j=Math.round(this.fontSize()/2);h.beginPath();h.moveTo(d,e-j);h.lineTo(d,e+j);h.stroke()}}};return{Constructor:g}});
//# sourceMappingURL=ui_graph.min.js.map
